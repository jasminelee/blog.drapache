#DBPYEXECUTE


start_session()


logged_in = SESSION.get('logged_in')


if logged_in:

	posts_meta = load_json('_posts.json')

	if 'id' in GETPARAMS:
		if not GETPARAMS['id']:
			die()
			
		post_id = GETPARAMS['id'][0]
		post_file = "_posts/post_%s.markdown" % post_id
		
		if post_id in posts_meta:
			post_meta = posts_meta[post_id]
		else:
			die("Bad post id")

		
		template_data = {}
		template_data['info'] = post_meta
		template_data['markdown'] = read_file(post_file)
		render_template('_edit_post.jinja',with_data=template_data)
		die()
		
	else:
		template_data = {}
		
		posts_list = [t[1] for t in sorted([(h['date'],h) for h in posts_meta.values()])]
		
		template_data['posts'] = posts_list
		render_template('_edit_blog.jinja',with_data=template_data)
		die()
		
		
else:
	
	SESSION['failed_attempt'] = True
	redirect('login')